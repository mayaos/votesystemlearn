<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- namespace value ： 实现的DAO接口的路径 -->
<mapper namespace="com.eastcompeace.system.log.LogDao">

	<!-- resultMap:定义结果集中表字段与实体类属性的映射关系 -->
	<resultMap type="Log" id="logMap">
		<result property="id" column="id"/>
		<result property="userid" column="user_id"/>
		<result property="requesturl" column="request_url"/>
		<result property="ip" column="ip"/>
		<result property="issuccess" column="issuccess"/>
		<result property="happentime" column="happentime"/>
		<result property="logcontent" column="log_content"/>
		<result property="logtype" column="log_type"/>
		<result property="username" column="user_name"/>
	</resultMap>
	
	<resultMap type="Logdownload" id="logdownloadMap">
		<result property="requesturl" column="request_url" />
		<result property="ip" column="ip" />
		<result property="issuccess" column="issuccess" />
		<result property="happentime" column="happentime" />
		<result property="logcontent" column="log_content" />
		<result property="logtype" column="log_type" />
		<result property="username" column="user_name" />
	</resultMap>

	<insert id="add" useGeneratedKeys="true" parameterType="Log">
		insert into common_log (
		<if test="userid!=null and userid!='' ">
			user_id
		</if>
		<if test="username !=null and username !='' ">
			,user_name
		</if>
		<if test="requesturl !=null and requesturl !='' ">
			,request_url
		</if>
		<if test="ip!=null and ip!='' ">
			,ip
		</if>
		<if test="issuccess !=null and issuccess !='' ">
			,issuccess
		</if>
		<if test="happentime !=null and happentime !='' ">
			,happentime
		</if>
		<if test="logcontent !=null and logcontent !='' ">
			,log_content
		</if>
		<if test="logtype !=null and logtype !='' ">
			,log_type
		</if>
		) values (
		<if test="userid!=null and userid!='' ">
			#{userid}
		</if>
		<if test="username !=null and username !='' ">
			,#{username}
		</if>
		<if test="requesturl!=null and requesturl!='' ">
			,#{requesturl}
		</if>
		<if test="ip!=null and ip!='' ">
			,#{ip}
		</if>
		<if test="issuccess!=null and issuccess!='' ">
			,#{issuccess}
		</if>
		<if test="happentime!=null and happentime!='' ">
			,#{happentime}
		</if>
		<if test="logcontent!=null and logcontent!='' ">
			,#{logcontent}
		</if>
		<if test="logtype!=null and logtype!='' ">
			,#{logtype}
		</if>
		)
	</insert>
	
	<select id="queryForList" parameterType="Log" resultMap="logMap">
		select
			t.id,
			t.user_id,
			t.request_url,
			t.ip,
			CASE t.issuccess
				WHEN  'Y' THEN '成功'
				WHEN  'N' THEN '失败'
			END issuccess,
			date_format(t.happentime,'%Y-%m-%d %H:%i:%s') happentime,
			t.log_content,
			t.user_name,
			d.code_name as logtype
		from common_log t
		left join common_code_dict d on d.code_value = t.log_type and d.code_type='logType'  
		where 1=1
		<if test="id != null and id != ''">
			and t.id = #{id}
		</if>
		<if test="username != null and username != ''">
			and t.user_name LIKE CONCAT(CONCAT('%', #{username}),'%')
		</if>
		<if test="issuccess != null and issuccess != ''">
			and t.issuccess = #{issuccess}
		</if>
		<if test="logtype != null and logtype != ''">
			and t.log_type = #{logtype}
		</if>
		<if test="happentimeStart != null and happentimeStart != ''">
            <![CDATA[ and t.happentime >= #{happentimeStart} ]]>
		</if>
		<if test="happentimeEnd != null and happentimeEnd != ''">
            <![CDATA[ and t.happentime <= #{happentimeEnd} ]]>
		</if>
		ORDER BY t.happentime DESC
	</select>

	<delete id="del" parameterType="list">
		delete from common_log where id in
		<foreach collection="list" index="index" item="item" open="("
			separator="," close=")">
			#{item}
		</foreach>
	</delete>

	<delete id="delall">
		delete from common_log
	</delete>

	<select id="queryForDownload" parameterType="Log" resultMap="logdownloadMap">
		select
			t.id,
			t.user_id,
			t.request_url,
			t.ip,
			CASE t.issuccess
				WHEN  'Y' THEN '成功'
				WHEN  'N' THEN '失败'
			END issuccess,
			date_format(t.happentime,'%Y-%m-%d %H:%i:%s') happentime,
			t.log_content,
			t.user_name,
			d.code_name as logtype
		from common_log t
		left join common_code_dict d on d.code_value = t.log_type and d.code_type='logType'  
		where 1=1
		<if test="id != null and id != ''">
			and t.id = #{id}
		</if>
		<if test="username != null and username != ''">
			and t.user_name LIKE CONCAT(CONCAT('%', #{username}),'%')
		</if>
		<if test="issuccess != null and issuccess != ''">
			and t.issuccess = #{issuccess}
		</if>
		<if test="logtype != null and logtype != ''">
			and t.log_type = #{logtype}
		</if>
		<if test="happentimeStart != null and happentimeStart != ''">
            <![CDATA[ and t.happentime >= #{happentimeStart} ]]>
		</if>
		<if test="happentimeEnd != null and happentimeEnd != ''">
            <![CDATA[ and t.happentime <= #{happentimeEnd} ]]>
		</if>
		ORDER BY t.happentime DESC
	</select>

</mapper>
	