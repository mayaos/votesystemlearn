<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- namespace value ： 实现的DAO接口的路径 -->
<mapper namespace="com.eastcompeace.usermng.authcitizen.AuthCitizenDao">

	<select id="queryListBy" resultType="citizenAuth" parameterType="Map">
		SELECT 
			t.auth_id authID,
			t.citizen_id citizenID,
			CASE t.auth_type 
			WHEN 1 THEN '身份证'
			WHEN 2 THEN '居住证'
			END authType,
			d.code_name authStatus,
			CASE t.auth_result 
			WHEN 'TRUE' THEN '成功'
			WHEN 'FALSE' THEN '失败'
			END authResult,
			t.auth_result_message authResultMessage,
			DATE_FORMAT(t.auth_time,'%Y-%m-%d %H:%i:%s') authTime,
			t2.user_name userName,
			t2.citizen_name citizenName,
			t2.id_card idCard,
			t2.rc_card rcCard
		FROM 
			(SELECT 
				*
			FROM citizen_auth ca
			WHERE 
				ca.auth_type = '2' 
				AND ca.citizen_id IN 
				(SELECT citizen_id FROM citizen_auth c
				WHERE auth_type = '1' AND c.auth_status = '3')
				ORDER BY ca.auth_id DESC) t

		LEFT JOIN citizen_info t2 ON t2.citizen_id = t.citizen_id
		LEFT JOIN common_code_dict d 
			ON d.code_value = t.auth_status 
			AND d.code_type = 'authStatus' 
			AND d.code_valid = 'VALID'
		WHERE 
		1 = 1
		<if test="userName !=null and userName !=''">
			and t2.user_name like concat('%', #{userName},'%')
		</if>
	    <if test="authStatus !=null and authStatus !=''">
		    and t.auth_status= #{authStatus}
	    </if>
	     <if test="startTime !=null and startTime !=''">
		    and t.auth_time between #{startTime} and #{endTime}
	    </if>
	</select> 
	
	<select id="selectCitizenInfo" resultType="citizenAuth" parameterType="String">
		SELECT 
			b.citizen_id citizenId,
			b.auth_type authType,
			b.auth_status authStatus,
			b.auth_time authTime,
			ci.user_name userName, 
			ci.citizen_name citizenName,
			ci.id_card idCard,
			ci.rc_card rcCard
		FROM 
			(SELECT 
				*
			FROM citizen_auth ca
			WHERE 
				ca.auth_type = '2' 
				AND ca.auth_status != '3' 
				AND ca.citizen_id IN 
				(SELECT citizen_id FROM citizen_auth c
				WHERE auth_type = '1' AND c.auth_status = '3')) b
		
			LEFT JOIN citizen_info ci
		ON 
		b.citizen_id = ci.citizen_id
		WHERE
		1 = 1
		<if test="startTime !=null and startTime !=''">
			and b.auth_time &gt;= #{startTime}
		</if>
	    <if test="endTime !=null and endTime !=''">
		    and b.auth_time &lt;= #{endTime}
	    </if>
	</select> 
	
	<select id="selectForCondition" resultType="citizenAuth" parameterType="String">
		SELECT 
			ca.citizen_id citizenId,
			ca.auth_type authType,
			ca.auth_status authStatus,
			ca.auth_time authTime,
			ci.user_name userName, 
			ci.citizen_name citizenName,
			ci.id_card idCard,
			ci.rc_card rcCard
			FROM citizen_auth ca
			
		LEFT JOIN citizen_info ci
		ON 
			ca.citizen_id = ci.citizen_id
		WHERE ca.auth_id in
		<foreach collection="list" index="index" item="item" open="("
			separator="," close=")">
			#{item}
		</foreach>
	</select>
	
	<select id="selectRcCardInfo" resultType="rcCardInfo" parameterType="Map">
		SELECT 
			c.name NAME,
			c.id_card idCard,
			c.rc_card rcCard,
			c.bank_card bankCard, 
			c.rc_card_type rcCardType,
			c.valid_thru validThru,
			c.citizen_no citizenNo
		FROM rc_card_info c 
	</select> 
	
	<select id="selectRcCardInfoForPerson" resultType="rcCardInfo">
		SELECT 
			c.name NAME,
			c.id_card idCard,
			c.rc_card rcCard,
			c.bank_card bankCard, 
			c.rc_card_type rcCardType,
			c.sex sex,
			c.birthday birthday,
			c.nation nation,
			c.address address,
			c.issue_date issueDate,
			c.issue_office issueOffice,
			c.valid_thru validThru,
			c.rc_head rcHead,
			c.citizen_serial_no citizenSerialNo,
			c.citizen_no citizenNo,
			c.import_date importDate
		FROM rc_card_info c
		where id_card in 
		<foreach collection="list" index="index" item="item" open="("
			separator="," close=")">
			#{item}
		</foreach>		
	</select>
	
	<select id="selectMaxImportDate" resultType="String" parameterType="String">
		SELECT rc.import_date FROM rc_card_info rc
		ORDER BY rc.import_date DESC LIMIT 0, 1
	</select> 
	
	<update id="updateCitizenAuth" parameterType="citizenAuth">
		update citizen_auth t
		<trim prefix="SET" suffixOverrides=","> 
			<if test="authStatus != null and authStatus != ''">
				t.auth_status = #{authStatus},
			</if>
			<if test="authResult != null and authResult != ''">
				t.auth_result = #{authResult},
			</if>
			<if test="authResultMessage != null and authResultMessage != ''">
				t.auth_result_message = #{authResultMessage},
			</if>
		</trim>
		where t.citizen_id = #{citizenID}
		and t.auth_type = '2'
	</update>
	
	<update id="updateCitizenUser" parameterType="citizenUser">
		update citizen_user c
		<trim prefix="SET" suffixOverrides=","> 
			<if test="userLevel != null and userLevel != ''">
				c.user_level = #{userLevel}
			</if>
		</trim>
		where c.citizen_id = #{citizenId}
	</update>
	
	<update id="updateCitizenIdentity" parameterType="rcCardInfo">
		update citizen_identity c
		<trim prefix="SET" suffixOverrides=","> 
			<if test="rcCard != null and rcCard != ''">
				c.rc_card = #{rcCard},
			</if>
			<if test="bankCard != null and bankCard != ''">
				c.bank_card = #{bankCard},
			</if>
			<if test="rcCardType != null and rcCardType != ''">
				c.rc_card_type = #{rcCardType},
			</if>
			<if test="sex != null and sex != ''">
				c.sex = #{sex},
			</if>
			<if test="birthday != null and birthday != ''">
				c.birthday = #{birthday},
			</if>
			<if test="nation != null and nation != ''">
				c.nation = #{nation},
			</if>
			<if test="address != null and address != ''">
				c.address = #{address},
			</if>
			<if test="issueDate != null and issueDate != ''">
				c.issue_date = #{issueDate},
			</if>
			<if test="issueOffice != null and issueOffice != ''">
				c.issue_office = #{issueOffice},
			</if>
			<if test="validThru != null and validThru != ''">
				c.valid_thru = #{validThru},
			</if>
			<if test="citizenSerialNo != null and citizenSerialNo != ''">
				c.citizen_serial_no = #{citizenSerialNo},
			</if>
			<if test="citizenNo != null and citizenNo != ''">
				c.citizen_no = #{citizenNo},
			</if>
			<if test="rcHead != null and rcHead != ''">
				c.rc_head = #{rcHead},
			</if>
		</trim>
		where c.citizen_id = #{citizenId}
	</update>
	
	<select id="selectForIdAuthLevalCitizenList" resultType="citizenAuth">
		SELECT 
			i.citizen_id citizenID,
			i.citizen_name citizenName,
			i.id_card idCard
		FROM 
			citizen_identity i ,citizen_user u
		WHERE
			i.`citizen_id`=u.`citizen_id` AND u.`user_level`='2'	
	</select>
	
	<select id="queryAuthInfo" resultType="citizenAuth" parameterType="String">
		SELECT 
			t.auth_type authType,
			t.auth_status authStatus,
			t.auth_result
		FROM citizen_auth t
		WHERE t.citizen_id = #{citizenID}
		AND t.auth_type = #{authType}
	</select>
	
	<insert id="insertAuth" parameterType="citizenAuth" keyProperty="auth_id">
		insert into citizen_auth (
			citizen_id,
			auth_type,
			auth_Status,
			auth_time
		)values (
			#{citizenID},
			#{authType},
			#{authStatus},
			NOW()
		)
	</insert>	
</mapper>