<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- namespace value ： 实现的DAO接口的路径 -->
<mapper namespace="com.eastcompeace.usermng.authuser.AuthUserDao">

	<select id="queryListBy" resultType="citizenAuth" parameterType="Map">
		select 
			t.auth_id authID,
			t.citizen_id citizenID,
			CASE t.auth_type 
			WHEN 1 THEN '身份证'
			WHEN 2 THEN '居住证'
			END authType,
			d.code_name authStatus,
			CASE t.auth_result 
			WHEN 'TRUE' THEN '成功'
			WHEN 'FALSE' THEN '失败'
			END authResult,
			t.auth_result_message authResultMessage,
			date_format(t.auth_time,'%Y-%m-%d %H:%i:%s') authTime,
			t2.user_name userName,
			t2.citizen_name citizenName,
			t2.id_card idCard,
			t2.rc_card rcCard
		from citizen_auth t
		Left join citizen_info t2 on t2.citizen_id = t.citizen_id
		left join common_code_dict d 
			on d.code_value = t.auth_status 
			and d.code_type = 'authStatus' 
			and d.code_valid = 'VALID'
		where t.auth_type = '1'
		<if test="userName !=null and userName !=''">
			and t2.user_name like concat('%', #{userName},'%')
		</if>
	    <if test="authStatus !=null and authStatus !=''">
		    and t.auth_status= #{authStatus}
	    </if>
	     <if test="startTime !=null and startTime !=''">
		    and t.auth_time between #{startTime} and #{endTime}
	    </if>
		ORDER BY t.auth_id DESC
	</select> 
	
	<select id="selectUserInfo" resultType="citizenAuth" parameterType="Map">
		SELECT 
			ca.citizen_id citizenId,
			ca.auth_type authType,
			ca.auth_status authStatus,
			ca.auth_time authTime,
			ci.user_name userName, 
			ci.citizen_name citizenName,
			ci.id_card idCard,
			ci.rc_card rcCard
			FROM citizen_auth ca
		LEFT JOIN citizen_info ci
		ON 
			ca.citizen_id = ci.citizen_id
		WHERE ca.auth_type = '1' AND ci.user_level='1'
		<if test="startTime !=null and startTime !=''">
			and ca.auth_time &gt;= #{startTime}
		</if>
	    <if test="endTime !=null and endTime !=''">
		    and ca.auth_time &lt;= #{endTime}
	    </if>
	</select> 
	
	<select id="selectRcCardInfo" resultType="rcCardInfo" parameterType="Map">
		SELECT 
			c.name NAME,
			c.id_card idCard,
			c.rc_card rcCard,
			c.bank_card bankCard, 
			c.import_date importDate
		FROM rc_card_info c
	</select> 
	
	<select id="selectRcCardInfoForPerson" resultType="rcCardInfo">
		SELECT 
			c.name NAME,
			c.id_card idCard,
			c.rc_card rcCard,
			c.bank_card bankCard, 
			c.rc_card_type rcCardType,
			c.sex sex,
			c.birthday birthday,
			c.nation nation,
			c.address address,
			c.issue_date issueDate,
			c.issue_office issueOffice,
			c.valid_thru validThru,
			c.rc_head rcHead,
			c.citizen_serial_no citizenSerialNo,
			c.citizen_no citizenNo,
			c.import_date importDate
		FROM rc_card_info c
		where id_card in 
		<foreach collection="list" index="index" item="item" open="("
			separator="," close=")">
			#{item}
		</foreach>		
	</select>
	
	<select id="selectMaxImportDate" resultType="String" parameterType="String">
		SELECT rc.import_date FROM rc_card_info rc
		ORDER BY rc.import_date DESC LIMIT 0, 1
	</select> 
	
	<select id="selectForCondition" resultType="citizenAuth" parameterType="String">
		SELECT 
			ca.citizen_id citizenId,
			ca.auth_type authType,
			ca.auth_status authStatus,
			ca.auth_time authTime,
			ci.user_name userName, 
			ci.citizen_name citizenName,
			ci.id_card idCard,
			ci.rc_card rcCard
			FROM citizen_auth ca
			
		LEFT JOIN citizen_info ci
		ON 
			ca.citizen_id = ci.citizen_id
		WHERE ca.auth_id in
		<foreach collection="list" index="index" item="item" open="("
			separator="," close=")">
			#{item}
		</foreach>
	</select>
	
	<update id="updateCitizenAuth" parameterType="citizenAuth">
		update citizen_auth t
		<trim prefix="SET" suffixOverrides=","> 
			<if test="authStatus != null and authStatus != ''">
				t.auth_status = #{authStatus},
			</if>
			<if test="authResult != null and authResult != ''">
				t.auth_result = #{authResult},
			</if>
			<if test="authResultMessage != null and authResultMessage != ''">
				t.auth_result_message = #{authResultMessage},
			</if>
		</trim>
		where t.citizen_id = #{citizenID}
		and t.auth_type = '1'
	</update>
	
	<update id="updateCitizenUser" parameterType="citizenUser">
		update citizen_user c
		<trim prefix="SET" suffixOverrides=","> 
			<if test="userLevel != null and userLevel != ''">
				c.user_level = #{userLevel}
			</if>
		</trim>
		where c.citizen_id = #{citizenId}
	</update>
	
</mapper>